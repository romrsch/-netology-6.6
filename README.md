## Домашнее задание к занятию "6.6. Troubleshooting"

### Задача 1

Перед выполнением задания ознакомьтесь с документацией по администрированию MongoDB.

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её нужно прервать.

Вы как инженер поддержки решили произвести данную операцию:

* напишите список операций, которые вы будете производить для остановки запроса пользователя
* предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

***Ответ:***

> напишите список операций, которые вы будете производить для остановки запроса пользователя

Определим текущую операцию командой:  

`db.currentOp()`

она сообщает о текущих текущих операциях для экземпляра базы данных MongoDB.

Каждая операция имеет свой уникальный идентификатор opid, который может быть использоваться для завершения данной операции с помощью команды `db.killOP()`

> предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB

При поиске документов в небольших коллекциях мы не испытаем особых проблем. Однако когда коллекции содержат миллионы документов, а нам надо сделать выборку по определенному полю, то поиск нужных данных может занять некоторое время, которое может оказаться критичным для нашей задачи. В этом случае нам могут помочь индексы.

Индексы позволяют упорядочить данные по определенному полю, что впоследствии ускорит поиск.

Поэтому чтобы не было долгих запросов, можно сздать соответствующие индексы ( с помощью метода `createIndex`)

---

### Задача 2

Перед выполнением задания познакомьтесь с документацией по Redis latency troobleshooting.

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и увеличивается пропорционально количеству реплик сервиса.

При масштабировании сервиса до N реплик вы увидели, что:

* сначала рост отношения записанных значений к истекшим
* Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?

***Ответ:***
Можно измерить задержки в контексте нашего приложения.
С помощью `redis-cli` для измерения задержки сервера Redis в миллисекундах
```
redis-cli --latency -h `host` -p `port`

```
Возможные проблемы:

1. Сеть. Возможны задержки связанные с работой сети и коммуникацией.


2. Медленные команды. Redis является однопоточным, все запросы обслуживаются последовательно.
 
* Следовательно мы можно посмотреть на все команды, которые мы используем, и определить сложность каждой команды. Если мы делаем кучу команд для больших объемов данных, то это будет вызывать задержки.

* Можно отслеживать медленные команды с помощью функции `Redis Slow Log`.

* Кроме того, мы можем использовать программы для мониторинга каждого процесса (top, htop, prstat и т. д.), Чтобы быстро проверить потребление ЦП основным процессом Redis. Если он высокий при отсутствии трафика, это обычно признак того, что используются медленные команды.

3. Ресурсы. Все данные в Redis хранятся в памяти, а не на дисках или твердотельных накопителях, как в других базах данных. Следовательно нужно добавить ресурсов (оперативной памяти, CPU) нашему хранилищу данных. 



---
### Задача 3

Перед выполнением задания познакомьтесь с документацией по Common Mysql errors.

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы, пользователи начали жаловаться на ошибки вида:

`InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '`

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения данной проблемы вы можете предложить?

***Ответ:***

Потеря соединения с MysQL, причины: рост количества соединений, рост нагрузки на БД, проблемы с работой сети.

Решение:

   1. Увеличить время ожидания - значения у параметров : 
   * connect_timeout, 
   * interactive_timeout, 
   * wait_timeout, 
   * net_read_timeout,  
   
   2. Добавить ресурсы серверу (CPU, оперативная память, быстрые диски)
 
   3. Увеличить производительность MySQL (существует специальный скрипт — MySQLTuner. Он анализирует работу базы данных и выводит рекомендации, какие параметры с какими значениями требуется изменить). Можно посмотреть рекомендации тюнера и последовать им


---

### Задача 4

Перед выполнением задания ознакомтесь со статьей Common PostgreSQL errors из блога Percona.

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили данную проблему?

***Ответ:***


Когда у сервера или процесса заканчивается память, Linux предлагает 2 пути решения: обрушить всю систему или завершить процесс (приложение), который съедает память.
`Out-Of-Memory Killer` — это процесс, который завершает приложение, чтобы спасти ядро от сбоя.

 Однако, отключение  OOM-Killer не выход.
 
 Linux может зарезервировать для процессов больше памяти, чем есть, но не выделять ее по факту, и этим поведением управляет параметр ядра Linux. За это отвечает переменная 
 ```
 vm.overcommit_memory.
```
Чтобы не приходилось использовать OOM-Killer для завершения PostgreSQL, установим для `vm.overcommit_memory` значение `2`. Это не гарантирует, что OOM-Killer не придется вмешиваться, но снизит вероятность принудительного завершения процесса PostgreSQL.

+ если есть возможность можно добавить ресурсуов серверу, провести ревизию и отключить или перенести с этого сервера ненужные приложения.
---
